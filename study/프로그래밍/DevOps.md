
# 🧰DevOps

#공부 #DevOps #CI/CD

---

# 컨테이너란 무엇일까?
- 애플리케이션을 실행하는데 필요한 모든 구성 요소와 기능을 갖춘 소프트웨어이다.
- 전체 실행(runtime)환경에서 애플리케이션을 패키징하고 격리할 수 있는 기술이다.

1. 컨테이너화 된 애플리케이션은 환경(개발/테스트/프로덕션)에 쉽게 이동할 수 있다.

2. 컨테이너 파이프라인에 보안을 구축하고 인프라를 보호하여 컨테이너의 안정성, 확장성, 신뢰성을 보장할 수 있다.

3. 일관된 행동과 기능으로, 퍼블릭/프라이빗/클라우드 간에 쉽게 이동이 가능하다.
## 장점
4. 담당 영역을 분리하여 개발 팀과 운영 팀간의 충돌을 줄일 수 있다.
5. 오픈기술을 기반으로 하기 때문에, 최신 기술을 활용하여 다양하고 강력한 기술의 제품을 채택할 수 있다.
  ex) docker / k8s 등등
6. 클라우드 네이티브 개발 방식에 필요한 기반 기술을 제공한다.
## 컨테이너 오케스트레이션이란?
- 전사적으로 배포를 관리할 수 있는 방법이다.
- k8s(쿠버네티스)는 컨테이너 작업을 자동화하는 오픈소스 플랫폼이다.
- 컨테이너화 된 애플리케이션을 배포하고 확장하는데 수동 프로세스를 필요로 하지 않는다.

## Docker와 Linux Container 의 차이?
	docker는 전통적인 LXC와 다르다. 
	docker도 처음에는 LXC기반으로 개발되었지만 이후, 이러한 종속관계에서 벗어났다.
	LXC는 경량/가상화 기술은 뛰어났지만 사용자환경은 그에 미치지 못햇다.
	하지만 docker는 컨테이너를 실행하는 것 이상의 다양한 생성/구축/이미지전송 등의 프로세스 관리를 용이하게 해준다.


---

# 젠킨스(Jenkins)는 정확히 무엇을 도와주는 녀석일까?
	- 젠킨스는 지속적 통합(CI)및 지속적 배포(CD)도구로, 
	 개발 프로세스의 빌드, 테스트, 배포 등을 자동화하고 관리해주는 도구이다.

### CI(Continuous Integration) 지속적인 통합
- 개발자들이 작성한 코드를 중앙 저장소에 자주 통합하고, 자동화된 빌드와
테스트를 통해 문제를 빠르게 발견하고 해결할 수 있게 해주는것.
 
### CD(Continuous Deployment) 지속적인 배포
- 모든 변경사항을 자동화된 테스트와 빌드를 거친 후 실제 서버에 자동으로
배포하는 기술. ( 현제 HF서비스에서는 ArgoCD를 사용하여 진행한다. )

---


# 젠킨스의 주요 기능

## 1. 젠킨스는 마스터노드와 슬레이브노드로 구성된다
- 이러한 구조를 통해 다양한 환경에서 동시에 빌드와 테스트를 수행할 수 있으며,
부하 분삭 및 확장성을 제공한다.

## 2. SCM트리거 및 웹훅
- 젠킨스는 소스코드관리(SCM)시스템과 통합하여 변경사항이 발견될때
 자동으로 빌드 및 테스트를 실행할 수 있다.
웹훅이나 폴링 방식을 사용하여 scm시스템에서 변경사항을 감지하고
해당작업을 트리거한다.

## 3. 결과 및 로그저장
 - 젠킨스는 빌드 및 테스트작업이 완료되면 해당결과와 로그를 저장한다.
이를 통해 빌드 실패의 원인을 찾거나 테스트 결과를 검토할수 있다.

## 4. 로그 및 메트릭 수집 및 분석
 - 젠킨스는 빌드, 테스트 및 배포 과정에서 발생하는 로그와 메트릭을 수집하고 
분석하여 성능문제, 장애, 최적화 포인트 등을 식별할 수 있다.


---


# 젠킨스의 동작원리

7. 개발자가 소스코드 변경사항을 SCM 시스템에 푸시한다.

8. 젠킨스는 웹훅이나 폴링 방식을 통해 변경사항을 감지하고 Jenkinsfile에 정의된 파이프라인을 실행한다.

9. 젠킨스는 마스터노드에서 슬레이브 노드로 작업을 할당하고 슬레이브 노드에서 빌드, 테스트 , 배포 작업을 수행한다.

10. 각 단계에서 필요의 경우, 플러그인을 사용하여 다양한 도구와 통합하여작업을 수행할 수 있다.

11. 작업이 완료되면 젠킨스는 결과와 로그를 저장하고 개발자에게 알림을 전송한다.


---


# Docker에 대한 자세한 설명
	 Linux 컨테이너를 만들고 사용할 수 있도록 하는 컨테이너화 기술이다.

	 컨테이너를 매우 가벼운 모듈식 가상 머신처럼 다룰 수 있으며, 컨테이너를 구축, 배포, 복사, 이동 등 유연하게 사용할 수 있도록 도와준다.
	 애플리케이션을 클라우드에 최적화 하도록 지원한다.

## docker컨테이너의 실행방식
- 커널과 네임스페이스 등 Linux의 기능을 사용하여 프로세스를 분리함으로 써, 독립적으로 실행할 수 있도록 한다.
- 개별적으로 실행하여 인프라를 더 효과적으로 활용하고 개별시스템을 사용할 때와 동일한 보안을 유지할 수 있도록 한다.
- 이미지 기반 배포 모델을 제공하여, 여러 환경에서 종속 항목과 손쉽게 공유 할 수 있다.

### 장점
12. 모듈성
	- 컨테이너화에 대한 docker의 접근방식은 전체 애플리케이션을 분해하지 않고도 업데이트 또는 복구를 가능하게 한다
13. 계층 및 이미지 버전제어
	- docker의 이미지파일은 일련의 계층으로 구성되며 이러한 계층들은 단일 이미지로 결합된다.
	이러한 이미지 계층을 재사용하여 구축 속도가 빠르며, 각 계층화에는 버전 제어가 가능하다.
14. 롤백
	- 롤백 기능을 제공하여 이전 이미지 버전으로 롤백이 가능하다.
15. 신속한 배포
	- 이전에는 하드웨어 확보, 실행, 프로비저닝, 테스트 하는데에 몇일이 걸렸으나, docker기반의 컨테이너는 배포 시간을 몇 초로 줄일 수 있다.

## Docker의 특징
- 도커는 애플리케이션 뿐만 아니라, 실행에 필요한 시스템 환경을 모아서 컨테이너로 관리한다. 이것을 Docker Image라고 한다.
- 이 이미지로 만든 컨테이너는 도커가 설치된 곳이라면 어디든 똑같이 작동함을 보장한다.

- 개발자가 커밋할때마다, Jenkins와 같은 CI( 지속적 통합 )툴이 해당 소스를 도커 이미지로 빌드하고, 이미지 레파지토리에서 이미지를 버전별로 관리한다.
- 해당 이미지를 배포 하면, 독립적으로 동작하기 때문에 CD( 지속적인 배포 )또한 가능하게 된다.
- 이러한 특징은 MSA와도 잘 맞는데, 각각의 서비스를 컨테이너로 배포하는 것이다.


---


# k8s(쿠버네티스)에 대한 자세한 설명
- 쿠버네티스는 "컨테이너화된 애플리케이션"을 배포, 관리, 확장 할때 수반되는 다수의 "수동 프로세스를 자동화"하는 오픈소스 "컨테이너 오케스트레이션 플랫폼"이다.
#### 컨테이너 오케스트레이션이 하는일
	1. 프로비저닝 및 배포
	2. 구성 및 일정 조정
	3. 리소스 할당
	4. 컨테이너 가용성 체크
	5. 로드밸런싱 기반 컨테이너 스케일링
	6. 트래픽 라우팅
	7. 컨테이너 상세 모니터링
	8. 컨테이너 간 상호작용 및 보안

### 쿠버네티스 주요 구성 요소
16. 클러스터 
	- 컨트롤 플레인 및 하나 이상의 컴퓨팅 머신 또는 노드를 뜻한다.
17. 컨트롤 플레인
	- 쿠버네티스 노드를 제어하는 프로세스의 컬렉션. 여기에 모든 태스크 할당이 시작된다.
18. kubelet
	- 노드에서 실행되며, 컨테이너 매니패스트를 읽고, 정의된 컨테이너가 실행중인지 확인한다.
19. 포드(Pod)
	- 단일 노드에 배포된 하나 이상의 컨테이너 그룹. 포드에 있는 모든 컨테이너는 IP주소.호스트 이름, 기타 리소스 등을 공유한다.
## k8s클러스터란?
	 작동 중인 쿠버네티스 배포를 클러스터라고 한다.
	 클러스터는 컨테이너를 실행하는 호스트 그룹으로, 컨트롤 플레인과 컴퓨팅머신의 2개 부분으로 시각화 할 수 있다.

## K8S와 Docker의 관계
	 Docker는 쿠버네티스가 오케스트레이션하는 컨테이너의 런타임으로 사용할 수 있다.
	 쿠버네티스가 노드에 대해 pod을 예약하면 해당 노드의 kubelet(각 컨테이너의 실행을 보장하는 서비스)가 지정된 컨테이너를 실행하도록 Docker에 명령한다.

	 이후, kubelet은 Docker로 부터, 지속적으로 상태를 수집하고 컨트롤 플레인에서 해당 정보를 집계한다.
** 한줄 요약 : docker는 k8s가 시키는데로(이미짜여진대로, 자동으로) 컨테이너를 실행한다.


---


# GitOps란?
	- DevOps(개발과 운영을 통합하여 효율성,협력,안정성을 개선하는 개발/운영 방법론)의 
	실천 방법중 하나로, 애플리케이션 배포와 운영에 관련된 모든요소를 
	 Git에서 관리(Opertation)한다는 뜻이다.
	- Git의 버전관리 시스템과 운영환경간의 일관성을 유지하여 소프트웨어간의 불일치 문제를
	해결할 수 있다.


---


# Argo CD란?
	- GitOps를 구현하기 위한 도구 중 하나로, 
	k8s애플리케이션의 자동배포(CD)를 위한 오픈소스 도구 이다.
	k8s클러스터에 배포된 애플리케이션의 CD를 담당한다.
	- Git저장소에서 변경사항을 감지하여 자동으로 k8s클러스터에 애플리케이션을 배포한다.


---


# 쿠버네티스의 매니페스트 파일이란?

- 쿠버네티스는 클러스터 안에서 컨테이너 애플리케이션이나 네트워크 설정, 배치 실행을 하는 Job등
 리소스를 작성한다. 이와 같은 구체적인 설정 정보를 파일로 관리하는데, 
 이것이 매니페스트파일(manifest file)이라고 한다.
- JSON이나 YALM 파일로 작성되며, 오브젝트를 생성하기 위해 필요한 파일이기도 하다.


---


# 현재 HF서비스의 CI/CD과정

## 1. Git에서 Commit / push하여 소스통합
	 local브랜치에서 작업 후 각(dev/stg/prod)프로젝트로 소스를 통합(merge)한다.

## 2. Jenkins에서 Git 소스 Build,Test&Publish 후 이미지화 (CI)
	jar, 메니페스트 file 등 소스,배포에 필요한 파일들 이미지 화

## 3. Docker에서 이미지 정보 받은 후 ArgoCD로 이미지 Pull
	 Jenkin에서 이미지화된 배포에 필요한 파일,소스들을 ArgoCD로 Pull한다.

## 4. ArgoCD로 이미지파일 K8S에 배포 (CD)
	 Jenkins에서 받은 이미지파일과 매니패스트파일을 기반으로 실제 서버에 배포한다.

## 5. K8S(쿠버네티스)에서 이미지파일 Docker를 통해 실행(서버실행)

### 각 과정에서 오류 및 예외 사항들을 찾고 대응 할 수 있도록
### 로그를 제공한다.

![[Pasted image 20240531162124.png]]
#### elastic 에서도 동작중인 서버의 모든 로그를 검색, 필터링 할 수 있다. 하나의 trace_id로 묶인 트렌젝션 단위를 기준으로 오류를 찾고 대응할 수 있다.

---

# Git Lab(깃랩) / Git Hub(깃허브) 차이

- 두가지 모두 소스코드 저장소 호스팅 플랫폼이며, 기술적 기반을 깃(Git)으로 삼는다는 점에서 비슷하다.
- 기본 기능은 같지만, 서비스의 초점이 조금 다른곳에 맞추어져 있다.

## 1. DevOps(데브옵스)
- 깃허브와 깃랩의 가장 큰 차이점은 데브옵스 요소에 있다.

### 깃랩은 지속적 통합(CI)/지속적 배포(CD)와 데브옵스 워크플로우를 내장하고 있다.
### 반면, 깃허브는 사용작 원하는 CI/CD도구를 직접 통합해야한다. 
* 즉 깃랩은 젠킨스와 아르고와 같은 CI/CD 도구들을 사용하지 않아도 자체적으로 파이프라인을 구성하여 간단하고 빠른 배포가 가능하다. 하지만 우리는 깃랩은 사용하지만, 깃랩CI/CD는 사용하고 있지 않은 상태이다.

## 2. 브랜치의 병합과 분리

### 깃허브에서는 브랜치 전략이라는 말이 있을만큼 새 브랜칭와 마스터 브랜치와의 병합이 용이하다.
- 그덕에 신속한 배포가 가능하고, 문제 발생시 이전 버전으로 신속하게 복원할 수 있다.

### 깃랩의 워크플로우는 변경한 각 세트를 마스터 브랜치와 별도의 안정적인 브랜치로 생성한다.
- 프로덕션과 스테이징의 분기가 최소한으로 있으며, 이러한 여러 다중 분기 접근방식은 여러단계의 테스트로 안정적인 유지가 가능하게 한다. 한편 이러한 이유로 병합및 수정시 코드 검토가 까다로워진다.


---


# Hello CI-CD

![[Pasted image 20240722180706.png]]


---

# Grafana Loki 란?

## 우리가 기존에 사용하던 ELK
- ELK란  elastic / logstash / kibana 의 앞글자를 딴 시슷템으로 
데이터를 수집, 처리, 조회 하는데 특화되어있는 시스템이다.

### Elastic search는 강력한 검색 및 쿼리 기능을 제공하여 다양한 조건으로 로그를 검색하고원하는 데이터를 쉽게 추출할 수 있다. 

### Logstash는 다양한 데이터 형식을 수집하고 변환할 수 있는 기능제공한다.

*  인덱스란 ? - 단일 데이터 단위를 도큐먼트라고 하며, 이 도큐먼트를 모아놓은 집합을 인덱스라고 한다.
## ELK 서비스의 한계점

- 인덱스 용량이 증가함에 따라 운영부담과 비용이 크게 증가한다.
- 튜닝을 통한 안정화에 한계가 있다.

## Loki의 장점

- 수평 확장이 가능하다
- 가용성 높은 다중 테넌트 로그 집계가 가능하다
- 로그에 대한 메타데이터만 인덱싱한다. 즉 레이블을 기반으로 구축되어있다.
- 로그 내용을 색인화 하는것이 아닌, 레이블 세트를 색인화 하기 때문에 데이터 량을 감소시킬 수 있다.

- 검색시 레이블 기반으로만 조회하고, 레이블과 매칭된 압축된 로그 데이터를 가져와 사용한다.

## Loki의 한계

- 풀텍스트 검색시 기존 ELK대비 느리다.
- 쿼리언어를 새로이 학습해야한다.
- 레퍼런스가 부족하다.


#### 결론 : 기존 ELK대비 높은 압출률을 가진 구조로, 로그를 오랫동안 보관하기에도 용의하며 확장에 유리하다.

---
